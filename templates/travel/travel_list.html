{% load static %}
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LLM ê¸°ë°˜ ì—¬í–‰ ì¶”ì²œ ì½”ìŠ¤</title>
    <style>
        body { font-family: 'Malgun Gothic', sans-serif; display: flex; height: 100vh; margin: 0; }
        #recommendation-list { width: 350px; padding: 20px; overflow-y: auto; border-right: 1px solid #ddd; background-color: #f8f8f8; box-sizing: border-box; }
        #map-container { flex-grow: 1; height: 100%; }
        #map { width: 100%; height: 100%; }
        .recommendation-item { 
            padding: 15px; 
            margin-bottom: 10px; 
            border: 1px solid #ddd; 
            border-radius: 8px; 
            cursor: pointer; 
            transition: background-color 0.2s, box-shadow 0.2s;
            background-color: #fff;
        }
        .recommendation-item:hover { background-color: #fff0f0; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .item-name { font-weight: bold; font-size: 1.1em; color: #333; margin-bottom: 5px; }
        .item-category { font-size: 0.9em; color: #777; }
        .item-rationale { font-size: 0.8em; color: #007bff; margin-top: 5px; }
        #route-summary { 
            margin-top: 15px; 
            padding: 10px; 
            border: 1px solid #eee; 
            border-radius: 6px; 
            background: #fff; 
            font-size: 0.9em;
        }
        #route-steps { 
            margin-bottom: 15px; 
            padding: 10px 0; 
            border-top: 1px dashed #eee;
            font-size: 0.9em;
        }
        .route-step { margin-bottom: 4px; padding-left: 10px; border-left: 3px solid #ddd; }
        .route-order { font-weight: bold; color: #d63384; margin-right: 5px; }
    </style>
</head>
<body>
    
    <div id="recommendation-list">
        <h2>LLM ì¶”ì²œ ì½”ìŠ¤</h2>
        
        <div id="route-summary">
            ê²½ë¡œ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
        </div>
        
        <div id="route-steps">
            </div>

        {% for place in llm_recommendations %}
            <div class="recommendation-item" 
                 data-lat="{{ place.lat }}" 
                 data-lon="{{ place.lon }}"
                 onclick="moveToPlace({{ place.lat }}, {{ place.lon }})">
                <div class="item-name">{{ forloop.counter }}. {{ place.name }}</div>
                <div class="item-category">({{ place.category }})</div>
                <div class="item-rationale">{{ place.rationale }}</div>
            </div>
        {% endfor %}
    </div>

    <div id="map-container">
        <div id="map"></div>
    </div>

    <script>
        // views.pyì—ì„œ ì „ë‹¬ëœ ë³€ìˆ˜
        const KAKAO_APP_KEY = "{{ KAKAO_APP_KEY }}";
        const locationsJson = '{{ locations_json|escapejs }}'; 
        
        let recommendedPlaces = [];
        let routeData = {}; 
        
        try {
            const fullItinerary = JSON.parse(locationsJson);
            
            if (fullItinerary.length === 0) {
                console.error("ì¶”ì²œ ì¥ì†Œ ë°ì´í„°ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.");
            } else {
                if (fullItinerary[0] && fullItinerary[0].polyline_coords) {
                    // ê²½ë¡œ ë°ì´í„° ì¶”ì¶œ ë° ì œê±°
                    routeData = fullItinerary.shift(); 
                }
                recommendedPlaces = fullItinerary;
            }
        } catch (e) {
            console.error("JSON íŒŒì‹± ì˜¤ë¥˜:", e);
        }
        
        let map = null;
        let markers = [];
        let polyline = null;
        
        function initMap() {
            if (recommendedPlaces.length === 0) {
                document.getElementById('map').innerHTML = '<div style="text-align:center; padding-top:200px; color:#999;">ì¶”ì²œ ì¥ì†Œê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }

            const firstPlace = recommendedPlaces[0];
            
            const mapContainer = document.getElementById('map');
            const mapOption = {
                // ğŸš¨ğŸš¨ JS ë³€í™˜ ê°•í™” ğŸš¨ğŸš¨: lat/lonì´ ë¬¸ìì—´ë¡œ ì˜¬ ê²½ìš°ë¥¼ ëŒ€ë¹„í•´ parseFloat() ì‚¬ìš©
                center: new kakao.maps.LatLng(parseFloat(firstPlace.lat), parseFloat(firstPlace.lon)),
                level: 5 
            };
            
            map = new kakao.maps.Map(mapContainer, mapOption);

            displayRoute(recommendedPlaces);
        }

        function displayRoute(places) {
            markers.forEach(m => m.setMap(null));
            markers = [];
            if (polyline) polyline.setMap(null);
            
            const bounds = new kakao.maps.LatLngBounds();

            places.forEach((place, index) => {
                // ğŸš¨ğŸš¨ JS ë³€í™˜ ê°•í™” ğŸš¨ğŸš¨: place.lat, place.lonì´ ë¬¸ìì—´ì¼ ê²½ìš°ë¥¼ ëŒ€ë¹„
                const lat = parseFloat(place.lat);
                const lon = parseFloat(place.lon);

                if (isNaN(lat) || isNaN(lon)) {
                     console.error(`Invalid coordinates for place: ${place.name}`);
                     return;
                }
                
                const position = new kakao.maps.LatLng(lat, lon);
                bounds.extend(position);
                
            // ğŸš¨ğŸš¨ ë§ˆì»¤ ì´ë¯¸ì§€ URL ìˆ˜ì • ğŸš¨ğŸš¨
            // 404 ì˜¤ë¥˜ê°€ ë°œìƒí•œ URL ëŒ€ì‹ , ìœ íš¨í•œ ì¹´ì¹´ì˜¤ ìƒ˜í”Œ ì´ë¯¸ì§€ë¡œ êµì²´í•©ë‹ˆë‹¤.
            const imageSrc = 'https://t1.daumcdn.net/mapjs/resource/default/marker/number_l.png'; // ìƒˆë¡œìš´ ìœ íš¨ URL
            const imageSize = new kakao.maps.Size(35, 35); 
            
            // ì´ë¯¸ì§€ ì˜µì…˜ ìˆ˜ì •: ìƒˆë¡œìš´ ì´ë¯¸ì§€ì— ë§ê²Œ ìŠ¤í”„ë¼ì´íŠ¸ ì •ë³´ ìˆ˜ì •
            const imgOptions =  {
                spriteSize : new kakao.maps.Size(35, 349), 
                spriteOrigin : new kakao.maps.Point(0, index * 35), // ì¸ë±ìŠ¤ì— ë”°ë¼ ìœ„ì¹˜ ë³€ê²½
                offset: new kakao.maps.Point(17, 35) // ë§ˆì»¤ì˜ ì¤‘ì‹¬ ì¢Œí‘œ
            };

            const markerImage = new kakao.maps.MarkerImage(imageSrc, imageSize, imgOptions);
            
            const marker = new kakao.maps.Marker({
                position: position,
                image: markerImage
            });

                marker.setMap(map);
                markers.push(marker);

                // ì¸í¬ìœˆë„ìš° (ì¥ì†Œ ì´ë¦„ í‘œì‹œ)
                const infowindow = new kakao.maps.InfoWindow({
                    content: '<div style="padding:6px; font-weight:bold;">' + place.name + '</div>'
                });
                kakao.maps.event.addListener(marker, 'mouseover', function() { infowindow.open(map, marker); });
                kakao.maps.event.addListener(marker, 'mouseout', function() { infowindow.close(); });
            });
            
            // 2. ê¸¸ ì°¾ê¸° API ê²°ê³¼ë¡œ Polyline ê·¸ë¦¬ê¸° (ì‹¤ì œ ê²½ë¡œ)
            if (routeData.polyline_coords && routeData.polyline_coords.length > 0) {
                const routeLinePath = routeData.polyline_coords.map(coord => 
                    // coord[0]=ìœ„ë„(Lat), coord[1]=ê²½ë„(Lon)
                    new kakao.maps.LatLng(coord[0], coord[1]) 
                );

                polyline = new kakao.maps.Polyline({
                    path: routeLinePath, 
                    strokeWeight: 5, 
                    strokeColor: '#004CFF', 
                    strokeOpacity: 0.8, 
                    strokeStyle: 'solid'
                });
                
            } else {
                // API ì‹¤íŒ¨ ì‹œ ê¸°ì¡´ì˜ ì§ì„  ì—°ê²° ë°©ì‹ (Fallback)
                const fallbackLinePath = places.map(place => 
                    new kakao.maps.LatLng(parseFloat(place.lat), parseFloat(place.lon)) // ğŸš¨ğŸš¨ JS ë³€í™˜ ê°•í™” ğŸš¨ğŸš¨
                );
                polyline = new kakao.maps.Polyline({
                    path: fallbackLinePath, 
                    strokeWeight: 5, 
                    strokeColor: '#FF6432', 
                    strokeOpacity: 0.7, 
                    strokeStyle: 'solid'
                });
            }
            
            polyline.setMap(map);
            updateRouteSummary(places, routeData);
        
            if (!bounds.isEmpty()) {
                map.setBounds(bounds);
            }
        }
        
        function updateRouteSummary(places, data) {
            const summaryDiv = document.getElementById('route-summary');
            const stepsDiv = document.getElementById('route-steps');
            
            let summaryHtml = '';
            
            if (data.total_distance_km) {
                summaryHtml += '<h6>ğŸš— ìµœì  ê²½ë¡œ ì •ë³´ (ì¹´ì¹´ì˜¤ ê¸¸ ì°¾ê¸°)</h6>';
                summaryHtml += `<p><strong>ì´ ê±°ë¦¬:</strong> ${data.total_distance_km} km</p>`;
                summaryHtml += `<p><strong>ì´ ì˜ˆìƒ ì‹œê°„:</strong> ${data.total_duration_min} ë¶„ (ì°¨ëŸ‰ ê¸°ì¤€)</p>`;
            } else {
                // ê¸¸ ì°¾ê¸° API ì‹¤íŒ¨ ê²½ê³  ë©”ì‹œì§€
                summaryHtml += '<h6>ğŸš¨ ê¸¸ ì°¾ê¸° API ì‹¤íŒ¨ ë˜ëŠ” ì¥ì†Œ ë¶€ì¡±</h6>';
                summaryHtml += `<p>ì¹´ì¹´ì˜¤ REST API í‚¤ë‚˜ í†µì‹  ì˜¤ë¥˜ë¥¼ í™•ì¸í•˜ê±°ë‚˜ ì¥ì†Œë¥¼ 2ê°œ ì´ìƒ ì„ íƒí–ˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”. (í˜„ì¬ ì§ì„  ê²½ë¡œ í‘œì‹œ ì¤‘)</p>`;
            }
            
            summaryDiv.innerHTML = summaryHtml;
            
            stepsDiv.innerHTML = '<h6>ë°©ë¬¸ ìˆœì„œ (LLM ìµœì  ìˆœ)</h6>';
            places.forEach((place, index) => {
                stepsDiv.innerHTML += `
                    <div class="route-step">
                        <span class="route-order">${index + 1}.</span> ${place.name}
                        <span style="font-size:0.8em; color:#999;">(${place.category})</span>
                    </div>`;
            });
        }
        
        // ë¦¬ìŠ¤íŠ¸ ì•„ì´í…œ í´ë¦­ ì‹œ ì§€ë„ ì´ë™ í•¨ìˆ˜
        function moveToPlace(lat, lon) {
             // ğŸš¨ğŸš¨ JS ë³€í™˜ ê°•í™” ğŸš¨ğŸš¨: lat, lonì´ ì´ë¯¸ ì¸ë¼ì¸ ì´ë²¤íŠ¸ì—ì„œ ìˆ«ìë¡œ ë„˜ì–´ì™”ì„ ê²ƒì´ì§€ë§Œ, ì•ˆì „ì„ ìœ„í•´ ë‹¤ì‹œ í™•ì¸
             const moveLatLon = new kakao.maps.LatLng(parseFloat(lat), parseFloat(lon));
             map.panTo(moveLatLon);
        }


        // (loadKakaoSDK í•¨ìˆ˜ëŠ” ì´ì „ê³¼ ë™ì¼í•˜ê²Œ ìœ ì§€)
        function loadKakaoSDK(appKey, libraries, onSuccess, onError) {
            if (window.kakao && window.kakao.maps) {
                onSuccess();
                return;
            }

            const script = document.createElement('script');
            script.type = 'text/javascript';
            script.src = `//dapi.kakao.com/v2/maps/sdk.js?appkey=${appKey}&libraries=${libraries}&autoload=false`;
            script.onload = () => {
                kakao.maps.load(onSuccess);
            };
            script.onerror = onError;
            document.head.appendChild(script);
        }
        
        // ì‹¤ì œ ë¡œë“œ í˜¸ì¶œ
        loadKakaoSDK(KAKAO_APP_KEY, 'services',
            function onSdkLoaded() {
                initMap();
            },
            function onSdkError() {
                var map = document.getElementById('map');
                if (map) {
                    map.innerHTML = 'ì¹´ì¹´ì˜¤ ì§€ë„ SDK ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. í‚¤ë¥¼ í™•ì¸í•˜ì„¸ìš”.';
                }
            }
        );

    </script>
</body>
</html>