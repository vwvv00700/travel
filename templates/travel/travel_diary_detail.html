{% extends 'base.html' %}
{% load static %}

{% block title %}{{ travel_diary.name }} - 여행 다이어리{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto bg-white p-8 rounded-lg shadow-md border border-slate-200">
    <h1 class="text-3xl font-bold text-slate-800 mb-4">{{ travel_diary.name }}</h1>
    <p class="text-slate-600 mb-6">{{ travel_diary.start_date|date:"Y년 m월 d일" }} - {{ travel_diary.end_date|date:"Y년 m월 d일" }}</p>
    <p class="text-slate-700 mb-8">{{ travel_diary.description|default:"설명이 없습니다." }}</p>

    <div class="flex justify-between items-center mb-6">
        <div>
            <a href="{% url 'travel:upload_diary_entry_to_travel' travel_id=travel_diary.pk %}" class="bg-sky-600 hover:bg-sky-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out flex items-center inline-flex">
                <i class="fa-solid fa-plus mr-2"></i> 새로운 기록 추가
            </a>
            <a href="{% url 'travel:edit_travel_diary' pk=travel_diary.pk %}" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out flex items-center inline-flex ml-2">
                <i class="fa-solid fa-edit mr-2"></i> 다이어리 수정
            </a>
        </div>
        <div class="flex space-x-2">
            <button id="sort-time-btn" class="bg-amber-500 hover:bg-amber-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out">시간순 보기</button>
            <button id="sort-location-btn" class="bg-slate-500 hover:bg-slate-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out">지역순 보기 (지도)</button>
        </div>
    </div>

    <div id="time-sort-view" class="diary-view">
        {% if entries_by_date %}
            <div class="relative border-l-4 border-gray-200 ml-4 pl-4">
                {% for date, entries_for_date in entries_by_date %}
                    <div class="mb-8 relative">
                        <div class="absolute -left-6 flex items-center justify-center w-10 h-10 bg-blue-500 rounded-full ring-8 ring-white shadow-lg">
                            <span class="text-white text-sm font-bold">{{ date|date:"m/d" }}</span>
                        </div>
                        <h2 class="text-2xl font-bold text-slate-800 mb-4 ml-8">{{ date|date:"Y년 m월 d일" }}</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 ml-8">
                            {% for entry in entries_for_date %}
                                <div class="bg-slate-50 p-4 rounded-lg shadow-sm border border-slate-200 flex flex-col">
                                    {% if entry.photo %}
                                        <img src="{{ entry.photo.url }}" alt="{{ entry.location }}" class="w-full h-48 object-cover rounded-md mb-4">
                                    {% endif %}
                                    <h3 class="text-xl font-semibold text-slate-800 mb-2">{{ entry.location|default:"위치 정보 없음" }}</h3>
                                    <p class="text-sm text-slate-500 mb-3">{{ entry.timestamp|date:"H시 i분" }}</p>
                                    <p class="text-slate-700 text-base flex-grow">{{ entry.comment|default:"감상평이 없습니다." }}</p>
                                    <div class="mt-4 text-right flex justify-end space-x-2">
                                        <a href="{% url 'travel:edit_diary_entry' pk=entry.pk %}" class="text-blue-600 hover:text-blue-800 text-sm font-medium">편집</a>
                                        <a href="{% url 'travel:delete_diary_entry' pk=entry.pk %}" class="text-red-600 hover:text-red-800 text-sm font-medium">삭제</a>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <p class="text-center text-slate-600 text-lg py-10">아직 이 다이어리에 기록된 사진이 없습니다. 새로운 기록을 추가해보세요!</p>
        {% endif %}
    </div>

    <div id="location-sort-view" class="diary-view hidden">
        <div class="flex flex-col md:flex-row gap-6">
            <div id="map" class="w-full md:w-1/2 h-[500px] rounded-lg shadow-md"></div>
            <div id="location-photos" class="w-full md:w-1/2 h-[500px] overflow-y-auto bg-slate-50 p-4 rounded-lg shadow-md border border-slate-200">
                <p class="text-center text-slate-600 text-lg py-10">지도에서 위치를 선택하면 해당 위치의 사진이 표시됩니다.</p>
            </div>
        </div>
    </div>
</div>

<script id="diary-entries-data" type="application/json">
    {{ diary_entries_json|safe }}
</script>

<script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=290f79b4e40a1efbcba07b2da4bd4d39&libraries=services,clusterer,drawing"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const timeSortBtn = document.getElementById('sort-time-btn');
        const locationSortBtn = document.getElementById('sort-location-btn');
        const timeSortView = document.getElementById('time-sort-view');
        const locationSortView = document.getElementById('location-sort-view');
        const mapContainer = document.getElementById('map');
        const locationPhotosContainer = document.getElementById('location-photos');

        let map = null;
        let clusterer = null; // Initialize clusterer
        let markers = [];
        let currentInfowindow = null; // Added to track the currently open infowindow

        const diaryEntries = JSON.parse(document.getElementById('diary-entries-data').textContent);

        function showTimeSortView() {
            timeSortView.classList.remove('hidden');
            locationSortView.classList.add('hidden');
            timeSortBtn.classList.add('bg-amber-500', 'hover:bg-amber-600');
            timeSortBtn.classList.remove('bg-slate-500', 'hover:bg-slate-600');
            locationSortBtn.classList.add('bg-slate-500', 'hover:bg-slate-600');
            locationSortBtn.classList.remove('bg-amber-500', 'hover:bg-amber-600');
        }

        function showLocationSortView() {
            timeSortView.classList.add('hidden');
            locationSortView.classList.remove('hidden');
            locationSortBtn.classList.add('bg-amber-500', 'hover:bg-amber-600');
            locationSortBtn.classList.remove('bg-slate-500', 'hover:bg-slate-600');
            timeSortBtn.classList.add('bg-slate-500', 'hover:bg-slate-600');
            timeSortBtn.classList.remove('bg-amber-500', 'hover:bg-amber-600');

            if (!map) {
                map = new kakao.maps.Map(mapContainer, {
                    center: new kakao.maps.LatLng(37.5665, 126.9780), // Default to Seoul
                    level: 9
                });
                clusterer = new kakao.maps.MarkerClusterer({
                    map: map,
                    averageCenter: true,
                    minLevel: 10,
                    disableClickZoom: true // Disable click zoom to handle click event manually
                });
            }
            map.relayout(); // Recenter map after div becomes visible
            displayMarkers();
        }

        function displayMarkers() {
            if (clusterer) {
                clusterer.removeMarkers(markers);
            }
            markers = [];
            const bounds = new kakao.maps.LatLngBounds();

            // Group entries by location (latitude, longitude)
            const locations = {};
            diaryEntries.forEach(entry => {
                if (entry.latitude !== null && entry.longitude !== null) {
                    const key = `${entry.latitude},${entry.longitude}`;
                    if (!locations[key]) {
                        locations[key] = { lat: entry.latitude, lon: entry.longitude, name: entry.location, entries: [] };
                    }
                    locations[key].entries.push(entry);
                }
            });

            for (const key in locations) {
                const locationData = locations[key];
                const position = new kakao.maps.LatLng(locationData.lat, locationData.lon);
                const marker = new kakao.maps.Marker({
                    position: position,
                    title: locationData.name
                });

                // Store location data with the marker for easy access
                marker.locationData = locationData;

                kakao.maps.event.addListener(marker, 'click', function() {
                    if (currentInfowindow) {
                        currentInfowindow.close();
                    }
                                    const infowindow = new kakao.maps.InfoWindow({
                                        content: `<div style="padding:5px;font-size:12px;">사진: ${locationData.entries.length}개</div>`
                                    });                    infowindow.open(map, marker);
                    currentInfowindow = infowindow;
                    displayLocationPhotos(locationData.lat, locationData.lon);
                });

                markers.push(marker);
                bounds.extend(position);
            }

            if (clusterer) {
                clusterer.addMarkers(markers);

                // Handle cluster click event
                kakao.maps.event.addListener(clusterer, 'clusterclick', function(cluster) {
                    // If the cluster contains only one marker, treat it as a single marker click
                    if (cluster.getMarkers().length === 1) {
                        const marker = cluster.getMarkers()[0];
                        // Manually trigger the marker's click event
                        kakao.maps.event.trigger(marker, 'click');
                    } else {
                        // Zoom to the cluster's bounds to reveal individual markers
                        const level = map.getLevel() - 1;
                        map.setLevel(level, {anchor: cluster.getCenter()});
                    }
                });
            }

            if (!bounds.isEmpty()) {
                map.setBounds(bounds);
            }
        }

        function displayLocationPhotos(lat, lon) {
            locationPhotosContainer.innerHTML = ''; // Clear previous photos
            const filteredEntries = diaryEntries.filter(entry => entry.latitude === lat && entry.longitude === lon);

            if (filteredEntries.length > 0) {
                const locationName = filteredEntries[0].location;
                let photosHtml = `<h3 class="text-xl font-bold text-slate-800 mb-4">${locationName} (${filteredEntries.length}개)</h3>`;
                photosHtml += '<div class="grid grid-cols-1 gap-4">';
                filteredEntries.forEach(entry => {
                    photosHtml += `
                        <div class="bg-white p-3 rounded-lg shadow-sm border border-slate-200">
                            <img src="${entry.photo_url}" alt="${entry.location}" class="w-full h-40 object-cover rounded-md mb-2">
                            <p class="text-sm text-slate-700">${entry.comment}</p>
                            <p class="text-xs text-slate-500 mt-1">${entry.timestamp}</p>
                            <div class="mt-4 text-right flex justify-end space-x-2">
                                <a href="/travel/diary_entry/${entry.id}/edit/" class="text-blue-600 hover:text-blue-800 text-sm font-medium">편집</a>
                                <a href="/travel/diary_entry/${entry.id}/delete/" class="text-red-600 hover:text-red-800 text-sm font-medium">삭제</a>
                            </div>
                        </div>
                    `;
                });
                photosHtml += '</div>';
                locationPhotosContainer.innerHTML = photosHtml;
            } else {
                locationPhotosContainer.innerHTML = '<p class="text-center text-slate-600 text-lg py-10">선택한 위치에 사진이 없습니다.</p>';
            }
        }

        timeSortBtn.addEventListener('click', showTimeSortView);
        locationSortBtn.addEventListener('click', showLocationSortView);

        // Initial view
        showTimeSortView();
    });
</script>
{% endblock %}