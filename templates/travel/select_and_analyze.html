{% extends "admin/base_site.html" %}
{% load static %}

{% block content %}
<style>
/* --- ê¸°ë³¸ ìŠ¤íƒ€ì¼ --- */
.tab-container {
  margin: 20px 0;
}

.tab-buttons {display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 10px; }
.tab-buttons button { border: 1px solid #ccc; background-color: #f8f8f8; padding: 8px 14px; border-radius: 6px; cursor: pointer; font-weight: 500; }
.tab-buttons button.active { background-color: #333; color: white; border-color: #333; }
.tab-content { border: 1px solid #ccc; border-radius: 8px; padding: 15px; background-color: #fff; height: 400px; overflow: scroll;}

.category-block {display: none;}
.category-block.active {display: block;}

/* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
.button { background-color: #333; color: white; border: none; border-radius: 6px; padding: 8px 14px; cursor: pointer;}
.button:hover {background-color: #333;}
</style>

<div class="content" style="margin:20px;">

  <form method="post" action="{{ post_url }}">
    {% csrf_token %}
    <input type="hidden" name="action" value="analyze">

    {% if grouped_places %}
      <!-- âœ… íƒ­ ë²„íŠ¼ ì˜ì—­ -->
      <div class="tab-container">
        <div class="tab-buttons">
          {% for category, places in grouped_places.items %}
            <button type="button" class="tab-btn" data-category="{{ category }}">
              {{ category }}
            </button>
          {% endfor %}
        </div>

        <!-- âœ… íƒ­ ë‚´ìš© ì˜ì—­ -->
        <div class="tab-content">
          {% for category, places in grouped_places.items %}
          <div class="category-block" id="tab-{{ category }}" data-category="{{ category }}">
            <h3 style="margin-top:0;">{{ category }}</h3>

            <!-- íˆ´ë°” -->
            <div style="margin:5px 0 10px 0; display:flex; align-items:center; gap:10px;">
              <button type="button" class="btn-select-category" data-category="{{ category }}">â–¶ 100ê°œ ìë™ ì„ íƒ</button>
              <button type="button" class="btn-clear-category" data-category="{{ category }}">âœ– ì„ íƒ í•´ì œ</button>
              <strong>ì„ íƒ ìˆ˜: <span class="sel-count" data-category="{{ category }}">0</span> / 100</strong>
            </div>

            <ul style="list-style:none; padding-left:10px;">
              {% for place in places %}
              <li style="margin-bottom:4px;">
                <label>
                  <input type="checkbox" name="place_ids" value="{{ place.id }}" data-category="{{ category }}">
                  {{ place.name }}
                </label>
              </li>
              {% endfor %}
            </ul>
          </div>
          {% endfor %}
        </div>
      </div>

      <div style="margin-top:15px;">
        <button type="submit" class="button" style="padding:10px 20px;">ì„ íƒëœ ì¥ì†Œ ë¶„ì„í•˜ê¸°</button>
      </div>
    {% else %}
      <p>ë¶„ì„ ê°€ëŠ¥í•œ ì¥ì†Œê°€ ì—†ìŠµë‹ˆë‹¤.</p>
    {% endif %}
  </form>
</div>

<!-- âœ… JS: íƒ­ & ì„ íƒ ë¡œì§ -->
<script>
document.addEventListener("DOMContentLoaded", function() {
  const MAX = 100;

  // ----------------------------
  // ğŸ”¹ íƒ­ ì „í™˜ ê¸°ëŠ¥
  // ----------------------------
  const tabButtons = document.querySelectorAll(".tab-btn");
  const tabBlocks = document.querySelectorAll(".category-block");

  function activateTab(cat) {
    tabButtons.forEach(btn => btn.classList.toggle("active", btn.dataset.category === cat));
    tabBlocks.forEach(block => block.classList.toggle("active", block.dataset.category === cat));
  }

  if (tabButtons.length > 0) {
    activateTab(tabButtons[0].dataset.category); // ì²« íƒ­ ìë™ í™œì„±í™”
  }

  tabButtons.forEach(btn => {
    btn.addEventListener("click", e => {
      const cat = e.target.dataset.category;
      activateTab(cat);
    });
  });

  // ----------------------------
  // ğŸ”¹ ì„ íƒ / í•´ì œ / ì¹´ìš´íŠ¸
  // ----------------------------
  function updateCategoryCount(category) {
    const boxes = document.querySelectorAll(`input[name="place_ids"][data-category="${category}"]`);
    const count = Array.from(boxes).filter(b => b.checked).length;
    const label = document.querySelector(`.sel-count[data-category="${category}"]`);
    if (label) label.textContent = count;
  }

  function selectCategory(category, limit) {
    const boxes = Array.from(document.querySelectorAll(`input[name="place_ids"][data-category="${category}"]`));
    const unchecked = boxes.filter(b => !b.checked);
    unchecked.slice(0, limit).forEach(b => (b.checked = true));
    updateCategoryCount(category);
  }

  function clearCategory(category) {
    const boxes = document.querySelectorAll(`input[name="place_ids"][data-category="${category}"]`);
    boxes.forEach(b => (b.checked = false));
    updateCategoryCount(category);
  }

  // ë²„íŠ¼ ì´ë²¤íŠ¸ ì—°ê²°
  document.querySelectorAll(".btn-select-category").forEach(btn => {
    btn.addEventListener("click", e => {
      const cat = e.target.dataset.category;
      selectCategory(cat, MAX);
    });
  });

  document.querySelectorAll(".btn-clear-category").forEach(btn => {
    btn.addEventListener("click", e => {
      const cat = e.target.dataset.category;
      clearCategory(cat);
    });
  });

  // ì²´í¬ ì‹œ 100ê°œ ì´ˆê³¼ ë°©ì§€
  document.querySelectorAll('input[name="place_ids"]').forEach(chk => {
    chk.addEventListener("change", e => {
      const cat = e.target.dataset.category;
      const boxes = Array.from(document.querySelectorAll(`input[name="place_ids"][data-category="${cat}"]`));
      const count = boxes.filter(b => b.checked).length;
      if (count > MAX) {
        e.target.checked = false;
        alert(`${cat}ì€(ëŠ”) ìµœëŒ€ ${MAX}ê°œê¹Œì§€ë§Œ ì„ íƒí•  ìˆ˜ ìˆì–´.`);
      }
      updateCategoryCount(cat);
    });
  });

  // ì´ˆê¸° ì¹´ìš´íŠ¸
  const cats = new Set(Array.from(document.querySelectorAll('input[name="place_ids"]'))
                       .map(el => el.dataset.category));
  cats.forEach(updateCategoryCount);
});
</script>

{# 2) ë¶„ì„ ê²°ê³¼ í™”ë©´ + DB ì €ì¥ ë²„íŠ¼ #}
{% if analysis_results %}
<form method="post" action="{{ save_url }}">
    {% csrf_token %}
    <input type="hidden" name="action" value="save">

    <p style="margin:8px 0 16px;">ì•„ë˜ ê²°ê³¼ë¥¼ í™•ì¸í•˜ê³  <b>DB ì €ì¥</b>ì„ ëˆŒëŸ¬.</p>
    <button class="button default" type="submit" style="padding: 5px 10px;">DB ì €ì¥</button>
    <hr/>

    {% for item in analysis_results %}
    <h3>{{ forloop.counter }}. {{ item.place_name }}</h3>
    <pre style="white-space:pre-wrap; background:#f7f7f7; padding:10px; border-radius:6px; border:1px solid #eee;">
    {{ item.analysis_json_pretty }}
    </pre>

    <!-- âœ… ì „ì†¡ìš©ì€ compact JSONì„ textarea(hidden)ë¡œ ë³´ë‚¸ë‹¤. escape/escapejs ì“°ì§€ ë§ ê²ƒ -->
    <textarea name="payload_{{ item.place_pk }}" hidden>{{ item.analysis_json_compact|safe }}</textarea>
    {% endfor %}
</form>

<p style="margin-top:12px;">
    <a class="button" href="{{ post_url }}">ë‹¤ì‹œ ì„ íƒí•˜ê¸°</a>
</p>
{% endif %}
{% endblock %}
